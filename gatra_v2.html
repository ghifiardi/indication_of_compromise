<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GATRA v2.0 | Advanced Threat Simulation</title>
    <style>
        :root {
            --bg-color: #050505;
            --panel-bg: rgba(10, 10, 10, 0.85);
            --text-main: #e0e0e0;
            --text-muted: #666;
            --accent-green: #00ff41;
            --accent-red: #ff3333;
            --accent-orange: #ffaa00;
            --accent-blue: #00ccff;
            --accent-purple: #bc13fe;
            --border: 1px solid #333;
            --font-mono: 'Fira Code', 'Consolas', 'Monaco', monospace;
        }

        * {
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-color);
            background-image:
                linear-gradient(rgba(0, 255, 65, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 65, 0.03) 1px, transparent 1px);
            background-size: 20px 20px;
            color: var(--text-main);
            font-family: var(--font-mono);
            margin: 0;
            padding: 10px;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- HEADER --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: var(--panel-bg);
            border: var(--border);
            border-bottom: 2px solid var(--accent-green);
            margin-bottom: 10px;
            backdrop-filter: blur(5px);
        }

        h1 {
            margin: 0;
            font-size: 20px;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .sub-header {
            font-size: 10px;
            color: var(--accent-blue);
            letter-spacing: 1px;
        }

        .header-stats {
            display: flex;
            gap: 20px;
            font-size: 12px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 10px;
        }

        .stat-val {
            font-weight: bold;
            color: var(--accent-green);
        }

        button {
            background: rgba(0, 255, 65, 0.1);
            color: var(--accent-green);
            border: 1px solid var(--accent-green);
            padding: 8px 20px;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            font-size: 12px;
            transition: 0.2s;
            text-transform: uppercase;
        }

        button:hover {
            background: var(--accent-green);
            color: #000;
            box-shadow: 0 0 10px var(--accent-green);
        }

        button:disabled {
            border-color: #444;
            color: #444;
            cursor: not-allowed;
            background: transparent;
            box-shadow: none;
        }

        /* --- GRID LAYOUT --- */
        .grid-container {
            display: grid;
            grid-template-columns: 350px 1fr 300px;
            grid-template-rows: auto 1fr 250px auto;
            /* Added row for pipeline */
            gap: 10px;
            flex-grow: 1;
            height: calc(100vh - 80px);
        }

        .panel {
            background: var(--panel-bg);
            border: var(--border);
            padding: 0;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            background: rgba(255, 255, 255, 0.03);
            padding: 5px 10px;
            font-size: 11px;
            text-transform: uppercase;
            color: var(--accent-blue);
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-header .dots {
            letter-spacing: 2px;
            color: #444;
        }

        /* --- LOG FEED --- */
        #log-panel {
            grid-column: 1 / 2;
            grid-row: 2 / 4;
            /* Adjusted row span */
        }

        #log-stream {
            flex-grow: 1;
            overflow-y: hidden;
            font-size: 11px;
            line-height: 1.4;
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            font-family: 'Monaco', monospace;
        }

        .log-entry {
            margin-bottom: 4px;
            border-left: 2px solid transparent;
            padding-left: 5px;
            opacity: 0.8;
        }

        .log-entry:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.02);
        }

        .log-time {
            color: #555;
        }

        .key {
            color: #888;
        }

        .str {
            color: var(--accent-blue);
        }

        .num {
            color: var(--accent-orange);
        }

        .crit {
            border-left-color: var(--accent-red);
            background: rgba(255, 51, 51, 0.05);
        }

        .warn {
            border-left-color: var(--accent-orange);
        }

        .info {
            border-left-color: var(--accent-green);
        }

        /* --- MAP & VISUALIZATION --- */
        #map-panel {
            grid-column: 2 / 3;
            grid-row: 2 / 3;
            /* Adjusted row */
            position: relative;
        }

        canvas#attack-map {
            width: 100%;
            height: 100%;
            display: block;
        }

        .map-overlay {
            position: absolute;
            top: 40px;
            left: 10px;
            pointer-events: none;
            background: rgba(0, 0, 0, 0.6);
            padding: 5px 8px;
            border: 1px solid #333;
            border-radius: 2px;
            backdrop-filter: blur(2px);
        }

        .overlay-stat {
            font-size: 10px;
            color: #aaa;
            margin-bottom: 2px;
            font-family: 'Monaco', monospace;
        }

        /* --- METRICS --- */
        #metrics-panel {
            grid-column: 2 / 3;
            grid-row: 3 / 4;
            /* Adjusted row */
            display: flex;
            flex-direction: row;
            gap: 1px;
            background: #333;
        }

        .metric-col {
            flex: 1;
            background: var(--panel-bg);
            display: flex;
            flex-direction: column;
            padding: 10px;
        }

        .chart-container {
            flex-grow: 1;
            position: relative;
            width: 100%;
        }

        canvas.metric-chart {
            width: 100%;
            height: 100%;
            display: block;
        }

        .metric-val {
            font-size: 24px;
            font-weight: bold;
            color: #fff;
            margin: 5px 0;
        }

        .metric-label {
            font-size: 10px;
            color: #888;
            text-transform: uppercase;
        }

        /* --- THREAT & AGENTS --- */
        #side-panel {
            grid-column: 3 / 4;
            grid-row: 2 / 4;
            /* Adjusted row span */
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: transparent;
            border: none;
        }

        .side-module {
            background: var(--panel-bg);
            border: var(--border);
            padding: 10px;
            display: flex;
            flex-direction: column;
        }

        #threat-score-box {
            text-align: center;
            padding: 20px 10px;
            border-bottom: 2px solid var(--accent-green);
        }

        #threat-val {
            font-size: 48px;
            font-weight: bold;
            color: var(--accent-green);
            line-height: 1;
            text-shadow: 0 0 10px rgba(0, 255, 65, 0.3);
        }

        #threat-lbl {
            font-size: 12px;
            letter-spacing: 3px;
            margin-top: 5px;
            color: var(--accent-green);
        }

        .agent-list {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-top: 5px;
        }

        .agent-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 8px;
            border-left: 2px solid #444;
            font-size: 11px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .agent-item.active {
            border-left-color: var(--accent-green);
            background: rgba(0, 255, 65, 0.05);
        }

        .agent-item.alert {
            border-left-color: var(--accent-red);
            background: rgba(255, 51, 51, 0.1);
        }

        .agent-status {
            font-size: 9px;
            color: #888;
        }

        .agent-name {
            font-weight: bold;
        }

        #console-output {
            flex-grow: 1;
            background: #000;
            border: 1px solid #333;
            padding: 5px;
            font-size: 10px;
            color: #aaa;
            overflow-y: auto;
            font-family: 'Monaco', monospace;
            height: 150px;
        }

        .console-line {
            margin-bottom: 2px;
        }

        .console-line::before {
            content: "> ";
            color: #555;
        }

        /* --- PIPELINE --- */
        .pipeline-container {
            grid-column: 1 / -1;
            /* Span all columns */
            grid-row: 4 / 5;
            /* Last row */
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: var(--panel-bg);
            border: var(--border);
            border-top: 2px solid var(--accent-blue);
            padding: 10px 0;
            margin-top: 10px;
            backdrop-filter: blur(5px);
        }

        /* --- PIPELINE --- */
        .pipeline-container {
            grid-column: 1 / -1;
            /* Span all columns */
            grid-row: 4 / 5;
            /* Last row */
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: var(--panel-bg);
            border: var(--border);
            border-top: 2px solid var(--accent-blue);
            padding: 10px 0;
            margin-top: 10px;
            backdrop-filter: blur(5px);
        }

        .pipeline-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            color: var(--text-muted);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            flex: 1;
        }

        .pipeline-step.active .step-icon {
            border-color: var(--accent-green);
            color: var(--accent-green);
            box-shadow: 0 0 8px var(--accent-green);
        }

        .pipeline-step.active .step-label {
            color: var(--accent-green);
        }

        .step-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #444;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 5px;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .step-label {
            transition: color 0.3s ease;
        }

        .pipeline-connector {
            flex: 0 0 50px;
            /* Fixed width for connector */
            height: 2px;
            background: #333;
            position: relative;
            margin: 0 -25px;
            /* Overlap with steps */
        }

        .pipeline-connector.active {
            background: var(--accent-green);
            box-shadow: 0 0 5px var(--accent-green);
        }

        .pipeline-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            color: var(--text-muted);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            flex: 1;
        }

        .pipeline-step.active .step-icon {
            border-color: var(--accent-green);
            color: var(--accent-green);
            box-shadow: 0 0 8px var(--accent-green);
        }

        .pipeline-step.active .step-label {
            color: var(--accent-green);
        }

        .step-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #444;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 5px;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .step-label {
            transition: color 0.3s ease;
        }

        .pipeline-connector {
            flex: 0 0 50px;
            /* Fixed width for connector */
            height: 2px;
            background: #333;
            position: relative;
            margin: 0 -25px;
            /* Overlap with steps */
        }

        .pipeline-connector.active {
            background: var(--accent-green);
            box-shadow: 0 0 5px var(--accent-green);
        }

        /* UTILS */
        .blink {
            animation: blinker 1s linear infinite;
        }

        @keyframes blinker {
            50% {
                opacity: 0.3;
            }
        }

        .glitch {
            animation: glitch 0.2s cubic-bezier(.25, .46, .45, .94) both infinite;
            color: var(--accent-red);
        }

        @keyframes glitch {
            0% {
                transform: translate(0)
            }

            20% {
                transform: translate(-2px, 2px)
            }

            40% {
                transform: translate(-2px, -2px)
            }

            60% {
                transform: translate(2px, 2px)
            }

            80% {
                transform: translate(2px, -2px)
            }

            100% {
                transform: translate(0)
            }
        }
    </style>
</head>

<body>

    <header>
        <div>
            <h1>GATRA v2.0 <span style="color:var(--accent-blue)">// SIMULATION ENGINE</span></h1>
            <div class="sub-header">REAL-TIME THREAT EMULATION: GTG-1002 CAMPAIGN</div>
        </div>
        <div class="header-stats">
            <div class="stat-item">
                <span class="stat-label">UPTIME</span>
                <span class="stat-val" id="uptime">00:00:00</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">ACTIVE NODES</span>
                <span class="stat-val" id="val-nodes">1,024</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">DEFCON</span>
                <span class="stat-val" id="val-defcon" style="color:var(--accent-green)">5</span>
            </div>
        </div>
        <div>
            <button id="btn-start" onclick="startCampaign()">INITIATE ATTACK</button>
            <button id="btn-reset" onclick="resetSim()" disabled>RESET SYSTEM</button>
        </div>
    </header>

    <div class="grid-container">
        <!-- LEFT: LOGS -->
        <div class="panel" id="log-panel">
            <div class="panel-header">
                <span>INGESTION STREAM (SPLUNK)</span>
                <span class="dots">:::</span>
            </div>
            <div id="log-stream"></div>
        </div>

        <!-- CENTER TOP: MAP -->
        <div class="panel" id="map-panel">
            <div class="panel-header">
                <span>GLOBAL NETWORK ACTIVITY</span>
                <span class="dots">:::</span>
            </div>
            <canvas id="attack-map"></canvas>
            <div class="map-overlay">
                <div class="overlay-stat">SRC: GLOBAL</div>
                <div class="overlay-stat">DST: US-EAST-1</div>
            </div>
        </div>

        <!-- CENTER BOTTOM: METRICS -->
        <div class="panel" id="metrics-panel">
            <div class="metric-col">
                <span class="metric-label">REQUESTS / SEC</span>
                <span class="metric-val" id="val-rps" style="color:var(--accent-blue)">0</span>
                <div class="chart-container"><canvas id="chart-rps" class="metric-chart"></canvas></div>
            </div>
            <div class="metric-col">
                <span class="metric-label">NETWORK (MB/s)</span>
                <span class="metric-val" id="val-net" style="color:var(--accent-purple)">0.0</span>
                <div class="chart-container"><canvas id="chart-net" class="metric-chart"></canvas></div>
            </div>
            <div class="metric-col">
                <span class="metric-label">ERROR RATE (%)</span>
                <span class="metric-val" id="val-err" style="color:var(--accent-red)">0.0</span>
                <div class="chart-container"><canvas id="chart-err" class="metric-chart"></canvas></div>
            </div>
        </div>

        <!-- RIGHT: SIDEBAR -->
        <div id="side-panel">
            <div class="side-module" id="threat-score-box">
                <div style="font-size:10px; color:#666; margin-bottom:10px;">THREAT LEVEL</div>
                <div id="threat-val">0</div>
                <div id="threat-lbl">SECURE</div>
            </div>

            <div class="side-module" style="flex-grow:0;">
                <div class="panel-header" style="padding:0; margin-bottom:5px; border:none;">AGENTS</div>
                <div class="agent-list">
                    <div class="agent-item" id="agent-1">
                        <div>
                            <div class="agent-name">TEMPO_MONITOR</div>
                            <div class="agent-status">Scanning baseline...</div>
                        </div>
                        <div style="width:8px; height:8px; background:#444; border-radius:50%;" class="status-dot">
                        </div>
                    </div>
                    <div class="agent-item" id="agent-2">
                        <div>
                            <div class="agent-name">IAM_WATCHDOG</div>
                            <div class="agent-status">Monitoring auth...</div>
                        </div>
                        <div style="width:8px; height:8px; background:#444; border-radius:50%;" class="status-dot">
                        </div>
                    </div>
                    <div class="agent-item" id="agent-3">
                        <div>
                            <div class="agent-name">NET_SENTINEL</div>
                            <div class="agent-status">Deep Packet Insp...</div>
                        </div>
                        <div style="width:8px; height:8px; background:#444; border-radius:50%;" class="status-dot">
                        </div>
                    </div>
                    <div class="agent-item" id="agent-4">
                        <div>
                            <div class="agent-name">AUTO_RESPONDER</div>
                            <div class="agent-status">Standby</div>
                        </div>
                        <div style="width:8px; height:8px; background:#444; border-radius:50%;" class="status-dot">
                        </div>
                    </div>
                </div>
            </div>

            <div class="side-module" style="flex-grow:1; display:flex; flex-direction:column;">
                <div class="panel-header" style="padding:0; margin-bottom:5px; border:none;">SYSTEM CONSOLE</div>
                <div id="console-output"></div>
            </div>
        </div>

        <!-- BOTTOM: KILL CHAIN PIPELINE -->
        <div class="pipeline-container">
            <div class="pipeline-step" id="step-1">
                <div class="step-icon">1</div>
                <div class="step-label">RECON</div>
            </div>
            <div class="pipeline-connector" id="conn-1"></div>
            <div class="pipeline-step" id="step-2">
                <div class="step-icon">2</div>
                <div class="step-label">WEAPON</div>
            </div>
            <div class="pipeline-connector" id="conn-2"></div>
            <div class="pipeline-step" id="step-3">
                <div class="step-icon">3</div>
                <div class="step-label">DELIVERY</div>
            </div>
            <div class="pipeline-connector" id="conn-3"></div>
            <div class="pipeline-step" id="step-4">
                <div class="step-icon">4</div>
                <div class="step-label">LATERAL</div>
            </div>
            <div class="pipeline-connector" id="conn-4"></div>
            <div class="pipeline-step" id="step-5">
                <div class="step-icon">5</div>
                <div class="step-label">EXFIL</div>
            </div>
            <div class="pipeline-connector" id="conn-5"></div>
            <div class="pipeline-step" id="step-6">
                <div class="step-icon">6</div>
                <div class="step-label">DEFENSE</div>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTS & CONFIG ---
        const CONFIG = {
            users: ["j.doe", "m.smith", "sys_admin", "svc_backup", "root", "deploy_bot"],
            ips: ["192.168.1.45", "10.0.5.22", "172.16.0.4", "192.168.1.102", "10.20.1.5"],
            extIps: ["45.133.20.1", "185.220.101.4", "89.248.165.2", "103.208.86.5"],
            userAgents: [
                "Mozilla/5.0 (Windows NT 10.0; Win64; x64)",
                "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)",
                "python-requests/2.26.0",
                "curl/7.64.1",
                "Go-http-client/1.1"
            ],
            endpoints: ["/auth/login", "/v1/getData", "/api/userinfo", "/health", "/admin/config"],
            methods: ["GET", "POST", "PUT", "DELETE"]
        };

        // --- STATE ---
        let state = {
            running: false,
            phase: 0, // 0=Idle, 1=Recon, 2=Weapon, 3=Delivery, 4=Lateral, 5=Exfil, 6=Defense
            tick: 0,
            metrics: {
                rps: 12,
                net: 0.5,
                err: 0.1
            },
            activeNodes: 1024,
            defcon: 5,
            threat: 0,
            logs: [],
            attacks: [] // Active attack lines on map
        };

        // --- CANVAS SETUP ---
        const mapCanvas = document.getElementById('attack-map');
        const mapCtx = mapCanvas.getContext('2d');
        const chartRps = document.getElementById('chart-rps').getContext('2d');
        const chartNet = document.getElementById('chart-net').getContext('2d');
        const chartErr = document.getElementById('chart-err').getContext('2d');

        // Resize observer for canvas
        function resizeCanvas() {
            [mapCanvas, document.getElementById('chart-rps'), document.getElementById('chart-net'), document.getElementById('chart-err')].forEach(c => {
                c.width = c.parentElement.offsetWidth;
                c.height = c.parentElement.offsetHeight;
            });
        }
        window.addEventListener('resize', resizeCanvas);
        setTimeout(resizeCanvas, 100);

        // --- CHART CLASS ---
        class LineChart {
            constructor(ctx, color, maxVal) {
                this.ctx = ctx;
                this.color = color;
                this.data = new Array(50).fill(0);
                this.maxVal = maxVal;
            }
            push(val) {
                this.data.push(val);
                this.data.shift();
            }
            draw() {
                const w = this.ctx.canvas.width;
                const h = this.ctx.canvas.height;
                this.ctx.clearRect(0, 0, w, h);

                this.ctx.beginPath();
                this.ctx.strokeStyle = this.color;
                this.ctx.lineWidth = 2;

                const step = w / (this.data.length - 1);

                this.data.forEach((val, i) => {
                    const x = i * step;
                    const y = h - ((val / this.maxVal) * h);
                    if (i === 0) this.ctx.moveTo(x, y);
                    else this.ctx.lineTo(x, y);
                });
                this.ctx.stroke();

                // Fill
                this.ctx.lineTo(w, h);
                this.ctx.lineTo(0, h);
                this.ctx.fillStyle = this.color + "22"; // Low opacity
                this.ctx.fill();
            }
        }

        const charts = {
            rps: new LineChart(chartRps, '#00ccff', 2000),
            net: new LineChart(chartNet, '#bc13fe', 500),
            err: new LineChart(chartErr, '#ff3333', 100)
        };

        // --- 3D GLOBE LOGIC ---
        const GLOBE_RADIUS = 130;
        let globeRotation = 0;

        // 3D Projection Helper
        function project3D(lat, lon, radius) {
            const phi = (90 - lat) * (Math.PI / 180);
            const theta = (lon + 180) * (Math.PI / 180);

            const x = -(radius * Math.sin(phi) * Math.cos(theta));
            const z = (radius * Math.sin(phi) * Math.sin(theta));
            const y = (radius * Math.cos(phi));

            // Rotate around Y axis
            const rotX = x * Math.cos(globeRotation) - z * Math.sin(globeRotation);
            const rotZ = x * Math.sin(globeRotation) + z * Math.cos(globeRotation);

            // Perspective projection
            const scale = 300 / (300 - rotZ);
            const projX = rotX * scale + mapCanvas.width / 2;
            const projY = y * scale + mapCanvas.height / 2;

            return { x: projX, y: projY, z: rotZ, scale: scale, visible: rotZ < 0 };
        }

        // Country Coordinates (Lat, Lon)
        const countryCoords = {
            "US": { lat: 37.09, lon: -95.71 },
            "BR": { lat: -14.23, lon: -51.92 },
            "DE": { lat: 51.16, lon: 10.45 },
            "RU": { lat: 61.52, lon: 105.31 },
            "CN": { lat: 35.86, lon: 104.19 },
            "IN": { lat: 20.59, lon: 78.96 },
            "AU": { lat: -25.27, lon: 133.77 },
            "ZA": { lat: -30.55, lon: 22.93 },
            "HQ": { lat: 38.90, lon: -77.03 } // Washington DC
        };

        // Generate Globe Dots (Fibonacci Sphere for even distribution)
        const globeDots = [];
        const numDots = 600;
        const phi = Math.PI * (3 - Math.sqrt(5));

        for (let i = 0; i < numDots; i++) {
            const y = 1 - (i / (numDots - 1)) * 2;
            const radius = Math.sqrt(1 - y * y);
            const theta = phi * i;

            const x = Math.cos(theta) * radius;
            const z = Math.sin(theta) * radius;

            // Convert back to lat/lon for reuse of projection logic
            const lat = Math.asin(y) * (180 / Math.PI);
            const lon = Math.atan2(z, x) * (180 / Math.PI);

            globeDots.push({ lat, lon });
        }

        function drawMap() {
            const w = mapCanvas.width;
            const h = mapCanvas.height;
            mapCtx.clearRect(0, 0, w, h);

            globeRotation += 0.005; // Auto-rotate

            // 1. Atmosphere / Glow
            const cx = w / 2;
            const cy = h / 2;
            const glow = mapCtx.createRadialGradient(cx, cy, GLOBE_RADIUS * 0.8, cx, cy, GLOBE_RADIUS * 1.5);
            glow.addColorStop(0, "rgba(0, 255, 65, 0.05)");
            glow.addColorStop(1, "transparent");
            mapCtx.fillStyle = glow;
            mapCtx.fillRect(0, 0, w, h);

            // 2. Wireframe (Connect neighbors)
            // We'll connect dots that are close to each other to form a mesh
            // Optimization: Only connect a subset or use a fixed grid for wireframe if performance drops.
            // For now, let's just draw the dots with better depth cues.

            // Draw Globe Dots
            globeDots.forEach(dot => {
                const p = project3D(dot.lat, dot.lon, GLOBE_RADIUS);
                if (p.visible) {
                    // Depth Cue: Opacity and Size based on Z
                    // p.z ranges roughly from 0 to GLOBE_RADIUS (for visible side)
                    // Normalize z: 1 at front, 0.3 at horizon
                    const depth = Math.max(0.2, 1 - (p.z / GLOBE_RADIUS));

                    mapCtx.beginPath();
                    mapCtx.fillStyle = `rgba(80, 80, 80, ${depth})`;
                    mapCtx.arc(p.x, p.y, 1.5 * p.scale * depth, 0, Math.PI * 2);
                    mapCtx.fill();
                }
            });

            // 3. Latitude / Longitude Lines (Graticule) for Structure
            mapCtx.strokeStyle = "rgba(0, 255, 65, 0.05)";
            mapCtx.lineWidth = 1;

            // Draw Longitudes (Meridians)
            for (let lon = -180; lon < 180; lon += 30) {
                mapCtx.beginPath();
                let first = true;
                for (let lat = -90; lat <= 90; lat += 5) {
                    const p = project3D(lat, lon, GLOBE_RADIUS);
                    if (p.visible) {
                        if (first) { mapCtx.moveTo(p.x, p.y); first = false; }
                        else mapCtx.lineTo(p.x, p.y);
                    } else {
                        first = true; // Break line if goes behind
                    }
                }
                mapCtx.stroke();
            }

            // Draw Latitudes (Parallels)
            for (let lat = -75; lat <= 75; lat += 30) {
                mapCtx.beginPath();
                let first = true;
                for (let lon = -180; lon <= 180; lon += 5) {
                    const p = project3D(lat, lon, GLOBE_RADIUS);
                    if (p.visible) {
                        if (first) { mapCtx.moveTo(p.x, p.y); first = false; }
                        else mapCtx.lineTo(p.x, p.y);
                    } else {
                        first = true;
                    }
                }
                mapCtx.stroke();
            }

            // Draw HQ
            const hq = project3D(countryCoords.HQ.lat, countryCoords.HQ.lon, GLOBE_RADIUS);
            if (hq.visible) {
                mapCtx.fillStyle = "#00ff41";
                mapCtx.beginPath();
                mapCtx.arc(hq.x, hq.y, 3 * hq.scale, 0, Math.PI * 2);
                mapCtx.fill();
                mapCtx.shadowBlur = 10;
                mapCtx.shadowColor = "#00ff41";
                mapCtx.stroke();
                mapCtx.shadowBlur = 0;
            }

            // Draw Attacks (3D Arcs)
            state.attacks = state.attacks.filter(a => a.life > 0);
            state.attacks.forEach(a => {
                a.life--;

                const src = project3D(a.srcLat, a.srcLon, GLOBE_RADIUS);
                const dst = project3D(countryCoords.HQ.lat, countryCoords.HQ.lon, GLOBE_RADIUS);

                // Only draw if at least one point is visible or they are close
                if (src.visible || dst.visible) {
                    mapCtx.beginPath();
                    mapCtx.strokeStyle = a.color;
                    mapCtx.lineWidth = 1.5 * ((src.scale + dst.scale) / 2);

                    // Quadratic Bezier Control Point (flying high above surface)
                    // Simple approximation: midpoint elevated
                    const midX = (src.x + dst.x) / 2;
                    const midY = (src.y + dst.y) / 2 - 50; // Arch height

                    mapCtx.moveTo(src.x, src.y);
                    mapCtx.quadraticCurveTo(midX, midY, dst.x, dst.y);
                    mapCtx.stroke();

                    // Particle
                    const t = 1 - (a.life / 40);
                    const invT = 1 - t;
                    const px = invT * invT * src.x + 2 * invT * t * midX + t * t * dst.x;
                    const py = invT * invT * src.y + 2 * invT * t * midY + t * t * dst.y;

                    mapCtx.fillStyle = "#fff";
                    mapCtx.beginPath();
                    mapCtx.arc(px, py, 2, 0, Math.PI * 2);
                    mapCtx.fill();

                    // Label
                    if (a.life > 25 && src.visible) {
                        mapCtx.fillStyle = a.color;
                        mapCtx.font = "10px monospace";
                        mapCtx.fillText(`[${a.country}] ${a.type}`, src.x + 5, src.y);
                    }
                }
            });
        }

        function triggerAttackVisual(country, type, color = "#ff3333") {
            let coords = countryCoords[country];
            if (!coords) coords = countryCoords[Object.keys(countryCoords)[Math.floor(Math.random() * 8)]];

            state.attacks.push({
                srcLat: coords.lat,
                srcLon: coords.lon,
                country: country,
                type: type,
                life: 40,
                color: color
            });
        }

        // --- LOGGING LOGIC ---
        function addLog(entry, type = "info") {
            const el = document.createElement('div');
            el.className = `log-entry ${type}`;

            // Format as Splunk-style Key-Value Pairs
            const d = new Date();
            const ts = d.toISOString().replace('T', ' ').split('.')[0];

            // Splunk Format: Time Event key=value key=value
            let logStr = `<span class="log-time">${ts}</span> `;

            for (const [k, v] of Object.entries(entry)) {
                let valStr = v;
                // Quote strings if they contain spaces or are not numbers
                if (typeof v === 'string') {
                    valStr = `"<span class="str">${v}</span>"`;
                } else {
                    valStr = `<span class="num">${v}</span>`;
                }
                logStr += `<span class="key">${k}=</span>${valStr} `;
            }

            el.innerHTML = logStr;
            const container = document.getElementById('log-stream');
            container.appendChild(el);
            if (container.children.length > 20) container.removeChild(container.firstChild);
        }

        function logConsole(msg) {
            const el = document.getElementById('console-output');
            const line = document.createElement('div');
            line.className = 'console-line';
            line.innerText = msg;
            el.appendChild(line);
            el.scrollTop = el.scrollHeight;
        }

        // --- SIMULATION LOOP ---
        function runLoop() {
            state.tick++;

            // Baseline Noise
            if (Math.random() > 0.7) {
                addLog({
                    event: "api_request",
                    src_ip: CONFIG.ips[Math.floor(Math.random() * CONFIG.ips.length)],
                    method: "GET",
                    status: 200,
                    latency: Math.floor(Math.random() * 50) + 10
                });
            }

            // Phase Logic
            handlePhases();

            // Update Charts
            charts.rps.push(state.metrics.rps + (Math.random() * 10 - 5));
            charts.net.push(state.metrics.net + (Math.random() * 0.2 - 0.1));
            charts.err.push(state.metrics.err);

            Object.values(charts).forEach(c => c.draw());
            drawMap();

            // Update DOM Stats
            document.getElementById('val-rps').innerText = Math.floor(state.metrics.rps);
            document.getElementById('val-net').innerText = state.metrics.net.toFixed(1);
            document.getElementById('val-err').innerText = state.metrics.err.toFixed(1);

            // Update Header Stats
            document.getElementById('val-nodes').innerText = Math.floor(state.activeNodes).toLocaleString();
            const defconEl = document.getElementById('val-defcon');
            defconEl.innerText = state.defcon;

            // Colorize Defcon
            if (state.defcon === 1) { defconEl.style.color = "var(--accent-red)"; defconEl.classList.add('blink'); }
            else if (state.defcon <= 3) { defconEl.style.color = "var(--accent-orange)"; defconEl.classList.remove('blink'); }
            else { defconEl.style.color = "var(--accent-green)"; defconEl.classList.remove('blink'); }

            // Update Uptime
            const d = new Date();
            document.getElementById('uptime').innerText = d.toISOString().split('T')[1].split('.')[0];
        }

        function handlePhases() {
            if (!state.running) return;

            // Random fluctuations
            state.metrics.rps += (Math.random() - 0.5);

            // Update Pipeline UI
            for (let i = 1; i <= 6; i++) {
                const step = document.getElementById(`step-${i}`);
                const conn = document.getElementById(`conn-${i - 1}`); // Connector before step

                if (state.phase >= i) {
                    step.classList.add('active');
                    if (conn) conn.classList.add('active');
                } else {
                    step.classList.remove('active');
                    // Don't remove connector active state immediately to keep the path lit
                    // or remove it if we want strict phase indication. Let's keep it strict.
                    if (conn) conn.classList.remove('active');
                }
            }

            switch (state.phase) {
                case 1: // RECON
                    state.defcon = 4;
                    if (Math.random() > 0.8) {
                        addLog({
                            event: "port_scan",
                            src_ip: CONFIG.extIps[0],
                            dest_port: Math.floor(Math.random() * 65000),
                            action: "denied"
                        }, "warn");
                        triggerAttackVisual("CN", "PORT SCAN", "#ffaa00");
                    }
                    setThreat(20, "ELEVATED");
                    break;
                case 2: // WEAPONIZATION
                    state.defcon = 4;
                    if (Math.random() > 0.9) {
                        addLog({
                            event: "file_download",
                            file: "payload_v2.bin",
                            user: "j.doe",
                            hash: "a1b2c3d4..."
                        }, "warn");
                        triggerAttackVisual("RU", "MALWARE DL", "#ffaa00");
                    }
                    setThreat(35, "SUSPICIOUS");
                    break;
                case 3: // DELIVERY (High Tempo)
                    state.defcon = 3;
                    state.metrics.rps += 50; // Ramp up
                    state.metrics.err = 15.5;
                    // Minor node loss
                    if (state.tick % 10 === 0 && state.activeNodes > 900) state.activeNodes -= Math.floor(Math.random() * 5);

                    addLog({
                        event: "brute_force",
                        src_ip: CONFIG.extIps[1],
                        target: "admin",
                        count: 500
                    }, "crit");
                    triggerAttackVisual("BR", "BRUTE FORCE", "#ff3333");
                    triggerAttackVisual("CN", "DDOS FLOOD", "#ff3333");
                    setThreat(65, "ATTACK DETECTED");
                    break;
                case 4: // LATERAL
                    state.defcon = 2;
                    state.metrics.rps = 1200;
                    addLog({
                        event: "privilege_escalation",
                        user: "svc_backup",
                        command: "whoami /all",
                        alert: "T1078"
                    }, "crit");
                    setThreat(80, "CRITICAL");
                    updateAgent('agent-2', 'alert', 'Unusual Admin Access');
                    break;
                case 5: // EXFIL
                    state.defcon = 1;
                    state.metrics.net += 20; // Spike bandwidth
                    // Major node loss (systems going dark)
                    if (state.activeNodes > 600) state.activeNodes -= Math.floor(Math.random() * 10);

                    addLog({
                        event: "data_exfil",
                        dest_ip: CONFIG.extIps[2],
                        bytes: 50000000,
                        protocol: "DNS_TUNNEL"
                    }, "crit");
                    triggerAttackVisual("DE", "DATA EXFIL", "#bc13fe");
                    setThreat(95, "DATA LOSS IMMINENT");
                    updateAgent('agent-3', 'alert', 'DLP Triggered');
                    break;
                case 6: // DEFENSE
                    state.defcon = 5;
                    state.metrics.rps = 50;
                    state.metrics.net = 0;
                    // Recovery
                    if (state.activeNodes < 1024) state.activeNodes += 5;

                    addLog({
                        event: "soar_action",
                        action: "block_ip",
                        target: CONFIG.extIps[1],
                        status: "success"
                    }, "info");
                    setThreat(10, "CONTAINED");
                    updateAgent('agent-4', 'active', 'Threat Neutralized');
                    break;
            }
        }

        // --- CONTROLS ---
        function startCampaign() {
            if (state.running) return;
            state.running = true;
            document.getElementById('btn-start').disabled = true;
            document.getElementById('btn-reset').disabled = false;

            logConsole("Initializing GTG-1002 Simulation...");

            // Phase Timeline
            setTimeout(() => { state.phase = 1; logConsole("[PHASE 1] RECONNAISSANCE DETECTED"); updateAgent('agent-3', 'active', 'Scanning Inbound'); }, 2000);
            setTimeout(() => { state.phase = 2; logConsole("[PHASE 2] WEAPONIZATION / STAGING"); }, 6000);
            setTimeout(() => { state.phase = 3; logConsole("[PHASE 3] DELIVERY & EXPLOIT (High Volume)"); updateAgent('agent-1', 'alert', 'Tempo Anomaly'); }, 10000);
            setTimeout(() => { state.phase = 4; logConsole("[PHASE 4] LATERAL MOVEMENT"); }, 15000);
            setTimeout(() => { state.phase = 5; logConsole("[PHASE 5] EXFILTRATION"); }, 20000);
            setTimeout(() => { state.phase = 6; logConsole("[PHASE 6] AUTOMATED RESPONSE"); }, 25000);
        }

        function resetSim() {
            location.reload();
        }

        function setThreat(score, label) {
            state.threat = score;
            const el = document.getElementById('threat-val');
            el.innerText = score;
            document.getElementById('threat-lbl').innerText = label;

            if (score > 80) {
                el.style.color = "var(--accent-red)";
                el.classList.add('glitch');
            } else if (score > 50) {
                el.style.color = "var(--accent-orange)";
                el.classList.remove('glitch');
            } else {
                el.style.color = "var(--accent-green)";
                el.classList.remove('glitch');
            }
        }

        function updateAgent(id, status, msg) {
            const el = document.getElementById(id);
            el.className = `agent-item ${status}`;
            el.querySelector('.agent-status').innerText = msg;
            const dot = el.querySelector('.status-dot');
            dot.style.background = status === 'alert' ? 'var(--accent-red)' : 'var(--accent-green)';
        }

        // Init
        setInterval(runLoop, 200);

    </script>
</body>

</html>